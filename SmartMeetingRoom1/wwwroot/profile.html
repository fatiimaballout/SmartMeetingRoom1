<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Profile – SmartMeet</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
    <link href="/css/custom.css" rel="stylesheet" />
</head>
<body>
    <!-- Header -->
    <header id="header" class="header fixed-top d-flex align-items-center">
        <div class="d-flex align-items-center justify-content-between">
            <a href="index.html" class="logo d-flex align-items-center">
                <i class="bi bi-calendar-event"></i>
                <span class="d-none d-lg-block">SmartMeet</span>
            </a>
            <i class="bi bi-list toggle-sidebar-btn"></i>
        </div>

        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <li class="nav-item dropdown pe-3">
                    <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                        <img id="navAvatar" src="/assets/img/profile-img.jpg" class="rounded-circle" alt="Profile" />
                        <span class="d-none d-md-block dropdown-toggle ps-2" id="navUserName">Profile</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="profile.html"><i class="bi bi-person"></i> My Profile</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="btnSignOut"><i class="bi bi-box-arrow-right"></i> Sign Out</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>

    <!-- Sidebar -->
    <aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
            <li class="nav-item"><a class="nav-link" href="index.html"><i class="bi bi-grid"></i><span>Dashboard</span></a></li>
            <li class="nav-item"><a class="nav-link" href="booking.html"><i class="bi bi-calendar-plus"></i><span>Book Meeting</span></a></li>
            <li class="nav-item"><a class="nav-link" href="active-meeting.html"><i class="bi bi-camera-video"></i><span>Active Meeting</span></a></li>
            <li class="nav-item"><a class="nav-link" href="minutes.html"><i class="bi bi-journal-text"></i><span>Minutes</span></a></li>
            <li class="nav-item"><a class="nav-link" href="guest.html"><i class="bi bi-people"></i><span>My Meetings</span></a></li>
            <li class="nav-item"><a class="nav-link" href="profile.html"><i class="bi bi-person"></i><span>Profile</span></a></li>
        </ul>
    </aside>

    <!-- Main -->
    <main id="main" class="main">
        <div class="pagetitle">
            <h1>My Profile</h1>
            <nav>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                    <li class="breadcrumb-item active">Profile</li>
                </ol>
            </nav>
        </div>

        <section class="section">
            <div class="row">
                <!-- Left column -->
                <div class="col-lg-8">
                    <!-- Basic info -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Account</h5>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label" for="fullName">Full name</label>
                                    <input id="fullName" type="text" class="form-control" placeholder="Your name" />
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="userName">User name</label>
                                    <input id="userName" type="text" class="form-control" disabled />
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label" for="email">Email</label>
                                    <input id="email" type="email" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Roles</label>
                                    <div id="rolesWrap" class="d-flex flex-wrap gap-2 pt-2"></div>
                                </div>
                            </div>

                            <div class="mt-3 d-flex gap-2">
                                <button id="btnSaveProfile" class="btn btn-primary">
                                    <i class="bi bi-save me-1"></i> Save changes
                                </button>
                                <div id="profileError" class="text-danger small ps-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Password -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Change Password</h5>
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label" for="pwdCurrent">Current password</label>
                                    <input id="pwdCurrent" type="password" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" for="pwdNew">New password</label>
                                    <input id="pwdNew" type="password" class="form-control" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label" for="pwdConfirm">Confirm new password</label>
                                    <input id="pwdConfirm" type="password" class="form-control" />
                                </div>
                            </div>
                            <div class="mt-3 d-flex gap-2">
                                <button id="btnChangePwd" class="btn btn-outline-primary">
                                    <i class="bi bi-shield-lock me-1"></i> Update password
                                </button>
                                <div id="pwdError" class="text-danger small ps-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right column -->
                <div class="col-lg-4">
                    <!-- Avatar -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Profile Photo</h5>
                            <div class="text-center">
                                <img id="avatarPreview" src="/assets/img/profile-img.jpg" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover;" alt="Avatar" />
                                <input id="avatarInput" type="file" class="form-control" accept="image/*" />
                                <button id="btnUploadAvatar" class="btn btn-outline-secondary mt-2">
                                    <i class="bi bi-upload me-1"></i> Upload
                                </button>
                                <div id="avatarError" class="text-danger small mt-2"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Meta -->
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Account Info</h5>
                            <dl class="row mb-0">
                                <dt class="col-4">User ID</dt>
                                <dd class="col-8" id="metaUserId">—</dd>
                                <dt class="col-4">Email</dt>
                                <dd class="col-8" id="metaEmail">—</dd>
                                <dt class="col-4">Created</dt>
                                <dd class="col-8" id="metaCreated">—</dd>
                                <dt class="col-4">Last login</dt>
                                <dd class="col-8" id="metaLastLogin">—</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer id="footer" class="footer">
        <div class="copyright">&copy; <strong><span>SmartMeet</span></strong>. All Rights Reserved</div>
    </footer>

    <!-- Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="okToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-check-circle text-success me-2"></i>
                <strong class="me-auto">Success</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="okToastBody">Saved.</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const token = () =>
            localStorage.getItem('smr_access_token') ||
            sessionStorage.getItem('smr_access_token') || '';

        async function authedFetch(url, opts = {}) {
            return fetch(url, {
                ...opts,
                headers: { 'Authorization': 'Bearer ' + token(), ...(opts.headers || {}) }
            });
        }

        const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ?? ''; };
        const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v ?? ''; };
        const setHtml = (id, v) => { const el = document.getElementById(id); if (el) el.innerHTML = v ?? ''; };

        async function loadProfile() {
            const r = await authedFetch('/api/profile');
            if (!r.ok) { setText('profileError', 'Failed to load profile.'); return; }
            const me = await r.json();

            // top nav (optional)
            document.getElementById('navUserName').textContent = me.fullName || me.userName || 'Profile';
            if (me.avatarUrl) document.getElementById('navAvatar').src = me.avatarUrl;

            // form fields
            setVal('fullName', me.fullName ?? '');
            setVal('email', me.email ?? '');
            setVal('userName', me.userName ?? '');

            // roles
            document.getElementById('rolesWrap').innerHTML =
                (me.roles || []).map(r => `<span class="badge bg-secondary me-1">${r}</span>`).join('') ||
                '<span class="text-muted">None</span>';

            // avatar + meta
            document.getElementById('avatarPreview').src = me.avatarUrl || '/assets/img/profile-img.jpg';
            setText('metaUserId', me.id ?? '—');
            setText('metaEmail', me.email ?? '—');
            setText('metaCreated', me.createdUtc ? new Date(me.createdUtc).toLocaleString() : '—');
            setText('metaLastLogin', me.lastLoginUtc ? new Date(me.lastLoginUtc).toLocaleString() : '—');
        }

        async function onSaveProfile() {
            setText('profileError', '');
            const body = {
                fullName: document.getElementById('fullName').value.trim(),
                email: document.getElementById('email').value.trim()
            };

            const r = await authedFetch('/api/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });

            if (r.status === 204 || r.ok) {
                setText('profileError', '');
                showOk('Saved.');
                await loadProfile();
            } else {
                setText('profileError', (await r.text()) || 'Save failed.');
            }
        }

        async function onChangePassword() {
            setText('pwdError', '');
            const currentPassword = document.getElementById('pwdCurrent').value;
            const new1 = document.getElementById('pwdNew').value;
            const new2 = document.getElementById('pwdConfirm').value;

            if (!currentPassword || !new1 || !new2) {
                setText('pwdError', 'Fill all fields.'); return;
            }
            if (new1 !== new2) {
                setText('pwdError', 'New passwords do not match.'); return;
            }

            const r = await authedFetch('/api/profile/password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword: new1 })
            });

            if (r.status === 204 || r.ok) {
                setText('pwdError', '');
                showOk('Password updated.');
                document.getElementById('pwdCurrent').value = '';
                document.getElementById('pwdNew').value = '';
                document.getElementById('pwdConfirm').value = '';
            } else {
                setText('pwdError', (await r.text()) || 'Update failed.');
            }
        }

        async function onUploadAvatar() {
            setText('avatarError', '');
            const f = document.getElementById('avatarInput').files[0];
            if (!f) { setText('avatarError', 'Choose a file.'); return; }

            const fd = new FormData(); fd.append('file', f);
            const r = await authedFetch('/api/profile/avatar', { method: 'POST', body: fd });

            if (!r.ok) {
                setText('avatarError', (await r.text()) || 'Upload failed.');
                return;
            }

            const { url } = await r.json();
            document.getElementById('avatarPreview').src = url;
            document.getElementById('navAvatar').src = url;
            showOk('Avatar uploaded.');
        }

        // small toast helper
        function showOk(msg) {
            const el = document.getElementById('okToast');
            document.getElementById('okToastBody').textContent = msg || 'Done.';
            new bootstrap.Toast(el).show();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('btnSaveProfile').addEventListener('click', onSaveProfile);
            document.getElementById('btnChangePwd').addEventListener('click', onChangePassword);
            document.getElementById('btnUploadAvatar').addEventListener('click', onUploadAvatar);

            document.getElementById('btnSignOut')?.addEventListener('click', e => {
                e.preventDefault();
                localStorage.removeItem('smr_access_token');
                sessionStorage.removeItem('smr_access_token');
                location.href = '/login.html';
            });

            await loadProfile();
        });
    </script>


</body>
</html>
