<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Admin – Rooms | SmartMeet</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="/css/style.css" rel="stylesheet" />
    <link href="/css/custom.css" rel="stylesheet" />
</head>
<body>
    <header id="header" class="header fixed-top d-flex align-items-center">
        <div class="d-flex align-items-center justify-content-between">
            <a href="index.html" class="logo d-flex align-items-center">
                <i class="bi bi-calendar-event"></i>
                <span class="d-none d-lg-block">SmartMeet</span>
            </a>
            <i class="bi bi-list toggle-sidebar-btn"></i>
        </div>
        <nav class="header-nav ms-auto">
            <ul class="d-flex align-items-center">
                <li class="nav-item dropdown pe-3">
                    <a class="nav-link nav-profile d-flex align-items-center pe-0" href="#" data-bs-toggle="dropdown">
                        <img src="/assets/img/profile-img.jpg" alt="Profile" class="rounded-circle">
                        <span class="d-none d-md-block dropdown-toggle ps-2" id="navUserName">...</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" id="btnSignOut"><i class="bi bi-box-arrow-right"></i> Sign Out</a></li>
                    </ul>
                </li>
            </ul>
        </nav>
    </header>

    <aside id="sidebar" class="sidebar">
        <ul class="sidebar-nav" id="sidebar-nav">
            <li class="nav-item"><a class="nav-link collapsed" href="index.html"><i class="bi bi-grid"></i><span>Dashboard</span></a></li>
            <li class="nav-item"><a class="nav-link" href="admin.html"><i class="bi bi-gear"></i><span>Admin</span></a></li>
        </ul>
    </aside>

    <main id="main" class="main">
        <div class="pagetitle">
            <h1>Room Management</h1>
            <nav><ol class="breadcrumb"><li class="breadcrumb-item"><a href="index.html">Home</a></li><li class="breadcrumb-item active">Admin</li></ol></nav>
        </div>

        <section class="section">
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="card-title">Meeting Rooms</h5>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalRoom" id="btnAddRoom">
                                    <i class="bi bi-plus-circle me-2"></i>Add Room
                                </button>
                            </div>

                            <div class="table-responsive">
                                <table class="table table-striped" id="tblRooms">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Capacity</th>
                                            <th>Features</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="roomsTbody"></tbody>
                                </table>
                            </div>

                            <template id="roomRowTemplate">
                                <tr>
                                    <td data-field="name"></td>
                                    <td data-field="capacity"></td>
                                    <td data-field="features"></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1 btn-edit"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-sm btn-outline-danger btn-delete"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                            </template>

                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Add/Edit Room Modal (no Status) -->
    <div class="modal fade" id="modalRoom" tabindex="-1" aria-labelledby="modalRoomLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalRoomLabel">Add New Room</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="roomForm">
                        <input type="hidden" id="roomId" />
                        <div class="mb-3">
                            <label for="roomName" class="form-label">Room Name</label>
                            <input type="text" class="form-control" id="roomName" required />
                        </div>
                        <div class="mb-3">
                            <label for="roomCapacity" class="form-label">Capacity</label>
                            <input type="number" class="form-control" id="roomCapacity" min="1" max="100" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Features</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="featMic"><label class="form-check-label" for="featMic">Microphone</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="featProjector"><label class="form-check-label" for="featProjector">Projector</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="featScreen"><label class="form-check-label" for="featScreen">Screen</label>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="roomLocation" class="form-label">Location</label>
                            <input type="text" class="form-control" id="roomLocation" placeholder="(optional)" />
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCancelRoom">Cancel</button>
                    <button type="button" class="btn btn-primary" id="btnSaveRoom"><i class="bi bi-save me-2"></i>Save Room</button>
                </div>
            </div>
        </div>
    </div>

    <footer id="footer" class="footer">
        <div class="copyright">&copy; <strong><span>SmartMeet</span></strong>. All Rights Reserved</div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js" defer></script>
    <script defer>
        async function authedFetch(url, opts = {}) {
            const token = (localStorage.getItem('smr_access_token') || sessionStorage.getItem('smr_access_token') || '');
            return fetch(url, {
                ...opts,
                headers: {
                    'Content-Type': 'application/json',
                    ...(opts.headers || {}),
                    'Authorization': 'Bearer ' + token
                }
            });
        }

        function featuresToBadges(featuresString) {
            const arr = (featuresString || "").split(',').map(s => s.trim()).filter(Boolean);
            if (!arr.length) return '';
            return arr.map(f => `<span class="badge bg-info me-1">${f}</span>`).join('');
        }

        async function guardAdmin() {
            const token = (localStorage.getItem('smr_access_token') || sessionStorage.getItem('smr_access_token') || '');
            if (!token) { location.href = '/login.html'; return; }
            const meRes = await authedFetch('/api/auth/me');
            if (!meRes.ok) { location.href = '/login.html'; return; }
            const me = await meRes.json();
            document.getElementById('navUserName').textContent = me.userName ?? me.UserName ?? 'User';
            if (!Array.isArray(me.roles) || !me.roles.includes('Admin')) {
                location.href = '/index.html'; // not admin
            }
        }

        async function loadRooms() {
            const res = await authedFetch('/api/rooms');
            if (!res.ok) return;
            const rooms = await res.json();
            const tbody = document.getElementById('roomsTbody');
            const tpl = document.getElementById('roomRowTemplate');
            tbody.innerHTML = '';
            rooms.forEach(r => {
                const tr = tpl.content.firstElementChild.cloneNode(true);
                tr.dataset.id = r.id;
                tr.querySelector('[data-field="name"]').textContent = r.name;
                tr.querySelector('[data-field="capacity"]').textContent = (r.capacity ?? 0) + ' people';
                tr.querySelector('[data-field="features"]').innerHTML = featuresToBadges(r.features);
                tr.querySelector('.btn-edit').addEventListener('click', () => openEdit(r));
                tr.querySelector('.btn-delete').addEventListener('click', () => onDelete(r.id, r.name));
                tbody.appendChild(tr);
            });
        }

        function getFormPayload() {
            const id = document.getElementById('roomId').value || null;
            const name = document.getElementById('roomName').value.trim();
            const capacity = parseInt(document.getElementById('roomCapacity').value, 10) || 0;
            const features = [
                document.getElementById('featMic').checked ? 'Mic' : null,
                document.getElementById('featProjector').checked ? 'Projector' : null,
                document.getElementById('featScreen').checked ? 'Screen' : null,
            ].filter(Boolean).join(',');
            const location = document.getElementById('roomLocation').value.trim();
            return { id, name, capacity, features, location };
        }

        async function onSaveRoom() {
            const dto = getFormPayload();
            const isEdit = !!dto.id;
            const url = isEdit ? `/api/rooms/${dto.id}` : '/api/rooms';
            const method = isEdit ? 'PUT' : 'POST';
            const res = await authedFetch(url, { method, body: JSON.stringify(dto) });
            if (res.ok || res.status === 204 || res.status === 201) {
                bootstrap.Modal.getInstance(document.getElementById('modalRoom')).hide();
                await loadRooms();
            } else {
                const msg = await res.text();
                alert('Save failed: ' + msg);
            }
        }

        function openEdit(r) {
            document.getElementById('modalRoomLabel').textContent = 'Edit Room';
            document.getElementById('roomId').value = r.id;
            document.getElementById('roomName').value = r.name ?? '';
            document.getElementById('roomCapacity').value = r.capacity ?? 0;
            const feats = (r.features || '').split(',').map(s => s.trim());
            document.getElementById('featMic').checked = feats.includes('Mic');
            document.getElementById('featProjector').checked = feats.includes('Projector');
            document.getElementById('featScreen').checked = feats.includes('Screen');
            document.getElementById('roomLocation').value = r.location ?? '';
            new bootstrap.Modal('#modalRoom').show();
        }

        async function onDelete(id, name) {
            if (!confirm(`Delete room "${name}"?`)) return;
            const res = await authedFetch(`/api/rooms/${id}`, { method: 'DELETE' });
            if (res.status === 204) {
                await loadRooms();
            } else {
                const msg = await res.text();
                alert('Delete failed: ' + msg);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('btnSaveRoom').addEventListener('click', onSaveRoom);
            document.getElementById('btnAddRoom').addEventListener('click', () => {
                document.getElementById('modalRoomLabel').textContent = 'Add New Room';
                document.getElementById('roomForm').reset();
                document.getElementById('roomId').value = '';
            });
            document.getElementById('btnSignOut').addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.removeItem('smr_access_token');
                sessionStorage.removeItem('smr_access_token');
                location.href = '/login.html';
            });

            await guardAdmin();
            await loadRooms();
        });
    </script>
</body>
</html>
